### Criar Laboratório - Laboratório de Análises Clínicas
# ATENÇÃO: Este endpoint cria EMPRESA + LABORATÓRIO em uma transação!
# A empresa é criada automaticamente com tipoEmpresa = LABORATORIO_APOIO
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "codigo": "LAB-SL-001",
  "razao_social": "Laboratório São Lucas Análises Clínicas LTDA",
  "nome_fantasia": "Lab São Lucas",
  "cnpj": "12345678000190",
  "inscricao_estadual": "123456789",
  "inscricao_municipal": "987654321",
  "endereco": "Av. Paulista",
  "numero": "1000",
  "complemento": "Sala 501",
  "bairro": "Bela Vista",
  "cidade": "São Paulo",
  "uf": "SP",
  "cep": "01310100",
  "telefone_principal": "(11) 3456-7890",
  "telefone_secundario": "(11) 98765-4321",
  "email_principal": "contato@labsaolucas.com.br",
  "email_faturamento": "financeiro@labsaolucas.com.br",
  "website": "https://www.labsaolucas.com.br",
  "responsavel_tecnico": "Dr. João Silva",
  "conselho_responsavel": "CRF",
  "numero_conselho": "12345-SP",
  "tipo_integracao": "api",
  "url_integracao": "https://api.labsaolucas.com.br/v1",
  "token_integracao": "token-secreto-aqui",
  "metodos_envio_resultado": ["email", "portal"],
  "portal_resultados_url": "https://portal.labsaolucas.com.br",
  "prazo_entrega_normal": 3,
  "prazo_entrega_urgente": 1,
  "taxa_urgencia": 50.00,
  "percentual_repasse": 65.00,
  "aceita_urgencia": true,
  "envia_resultado_automatico": true,
  "observacoes": "Laboratório com certificação PALC. Atende urgências 24h.",
  "ativo": true
}

### Expected Response
# Status: 201 Created
# {
#   "id": "uuid",
#   "codigoLaboratorio": "LAB-SL-001",
#   "responsavelTecnico": "Dr. João Silva",
#   "tipoIntegracao": "api",
#   "empresa": {
#     "id": "uuid",
#     "cnpj": "12345678000190",
#     "razaoSocial": "Laboratório São Lucas Análises Clínicas LTDA",
#     "nomeFantasia": "Lab São Lucas"
#   },
#   ...
# }


### Criar Laboratório - Laboratório com Integração Manual
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "98765432000111",
    "razaoSocial": "Centro de Diagnósticos Médicos LTDA",
    "nomeFantasia": "CDM Diagnósticos",
    "email": "contato@cdmdiagnosticos.com.br",
    "telefone": "(11) 2345-6789",
    "celular": "(11) 99876-5432",
    "cep": "04543-011",
    "logradouro": "Av. Brigadeiro Luís Antônio",
    "numero": "2500",
    "bairro": "Jardim Paulista",
    "cidade": "São Paulo",
    "estado": "SP"
  },
  "codigoLaboratorio": "LAB-CDM-001",
  "responsavelTecnico": "Dra. Maria Santos",
  "conselhoResponsavel": "CRB",
  "numeroConselho": "54321-SP",
  "tipoIntegracao": "manual",
  "metodosEnvioResultado": ["email", "whatsapp"],
  "prazoPadraoEntregaNormal": 5,
  "prazoPadraoEntregaUrgente": 2,
  "taxaUrgencia": 35.00,
  "percentualRepasse": 70.00,
  "aceitaUrgencia": false,
  "enviaResultadoAutomatico": false,
  "observacoes": "Resultados enviados por email. Contato via WhatsApp."
}


### Criar Laboratório - Laboratório com WebService
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "11223344000155",
    "razaoSocial": "Laboratório BioTech Análises LTDA",
    "nomeFantasia": "BioTech Lab",
    "email": "sistemas@biotechlab.com.br",
    "telefone": "(11) 3333-4444",
    "celular": "(11) 97777-8888",
    "website": "https://www.biotechlab.com.br",
    "cep": "05408-000",
    "logradouro": "Av. Faria Lima",
    "numero": "3000",
    "complemento": "Conj. 1001",
    "bairro": "Itaim Bibi",
    "cidade": "São Paulo",
    "estado": "SP"
  },
  "codigoLaboratorio": "LAB-BT-001",
  "responsavelTecnico": "Dr. Carlos Oliveira",
  "conselhoResponsavel": "CRBM",
  "numeroConselho": "98765-SP",
  "tipoIntegracao": "webservice",
  "urlIntegracao": "https://ws.biotechlab.com.br/soap/v2",
  "usuarioIntegracao": "erplab_user",
  "senhaIntegracao": "senha-segura-123",
  "configuracaoAdicional": "{\"wsdl\": \"https://ws.biotechlab.com.br/soap/v2?wsdl\", \"namespace\": \"http://biotech.com.br/ws\"}",
  "metodosEnvioResultado": ["sistema", "portal"],
  "portalResultadosUrl": "https://resultados.biotechlab.com.br",
  "prazoPadraoEntregaNormal": 4,
  "prazoPadraoEntregaUrgente": 1,
  "taxaUrgencia": 45.00,
  "percentualRepasse": 60.00,
  "aceitaUrgencia": true,
  "enviaResultadoAutomatico": true,
  "observacoes": "Integração via SOAP/WebService. Certificado SSL obrigatório."
}


### Criar Laboratório - Laboratório com FTP
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "55667788000199",
    "razaoSocial": "Laboratório Exame Certo LTDA",
    "nomeFantasia": "Exame Certo",
    "email": "ti@examecerto.com.br",
    "telefone": "(11) 4444-5555",
    "celular": "(11) 96666-7777",
    "cep": "01419-001",
    "logradouro": "Rua Augusta",
    "numero": "1500",
    "bairro": "Consolação",
    "cidade": "São Paulo",
    "estado": "SP"
  },
  "codigoLaboratorio": "LAB-EC-001",
  "responsavelTecnico": "Dra. Ana Paula Lima",
  "conselhoResponsavel": "CRF",
  "numeroConselho": "11111-SP",
  "tipoIntegracao": "ftp",
  "urlIntegracao": "ftp://ftp.examecerto.com.br",
  "usuarioIntegracao": "erplab_ftp",
  "senhaIntegracao": "ftp-pass-456",
  "configuracaoAdicional": "{\"porta\": 21, \"modo\": \"passivo\", \"diretorio\": \"/resultados/\"}",
  "metodosEnvioResultado": ["ftp", "email"],
  "prazoPadraoEntregaNormal": 5,
  "prazoPadraoEntregaUrgente": 2,
  "taxaUrgencia": 30.00,
  "percentualRepasse": 75.00,
  "aceitaUrgencia": true,
  "enviaResultadoAutomatico": true,
  "observacoes": "Resultados disponibilizados via FTP diariamente às 20h."
}


### Erro - CNPJ Duplicado
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "12345678000190",
    "razaoSocial": "Outro Laboratório LTDA",
    "nomeFantasia": "Outro Lab"
  },
  "codigoLaboratorio": "LAB-OUT-001"
}

### Expected Response
# Status: 409 Conflict
# {
#   "statusCode": 409,
#   "message": "Já existe uma empresa com este CNPJ",
#   "error": "Conflict"
# }


### Erro - Código Laboratório Duplicado
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "99999999000188",
    "razaoSocial": "Novo Laboratório LTDA",
    "nomeFantasia": "Novo Lab"
  },
  "codigoLaboratorio": "LAB-SL-001"
}

### Expected Response
# Status: 409 Conflict
# {
#   "statusCode": 409,
#   "message": "Já existe um laboratório com este código",
#   "error": "Conflict"
# }


### Erro - CNPJ Inválido
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "empresaData": {
    "tipoEmpresa": "laboratorio",
    "cnpj": "12345",
    "razaoSocial": "Laboratório Teste LTDA",
    "nomeFantasia": "Lab Teste"
  },
  "codigoLaboratorio": "LAB-TEST-001"
}

### Expected Response
# Status: 400 Bad Request
# {
#   "statusCode": 400,
#   "message": ["cnpj must be a valid CNPJ"],
#   "error": "Bad Request"
# }


###############################################################################
### FLUXO COMPLETO: Criar Laboratório → Vincular a Método
###############################################################################

### PASSO 1: Criar laboratório (empresa + laboratório em transação)
POST {{baseUrl}}/relacionamento/laboratorios
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "codigo": "LAB999",
  "razao_social": "Lab Teste Fluxo LTDA",
  "nome_fantasia": "Lab Teste",
  "cnpj": "99988877000166",
  "endereco": "Rua Teste",
  "numero": "123",
  "bairro": "Centro",
  "cidade": "São Paulo",
  "uf": "SP",
  "cep": "01234567",
  "telefone_principal": "(11) 9999-9999",
  "email_principal": "teste@lab.com",
  "responsavel_tecnico": "Dr. Teste",
  "conselho_responsavel": "CRF",
  "numero_conselho": "999-SP",
  "tipo_integracao": "manual",
  "aceita_urgencia": true,
  "ativo": true
}

### Expected: Salvar o ID do laboratório retornado em {{laboratorioId}}

### PASSO 2: Verificar laboratório criado
GET {{baseUrl}}/relacionamento/laboratorios/{{laboratorioId}}
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

### PASSO 3: Vincular laboratório a um método
POST {{baseUrl}}/exames/laboratorios-metodos
Content-Type: {{contentType}}
Authorization: Bearer {{token}}

{
  "laboratorioId": "{{laboratorioId}}",
  "metodoId": "{{metodoId}}",
  "validado": false,
  "observacoes": "Método em processo de validação"
}

### Expected: Vínculo criado com sucesso! ✅
